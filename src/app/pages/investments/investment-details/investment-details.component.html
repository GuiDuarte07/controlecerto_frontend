<main class="w-full mb-6">
  <section class="registration-container !max-w-full overflow-hidden lg:!w-[800px]">
    <!-- Header -->
    <div class="flex items-center gap-3 mb-6">
      <button pButton type="button" icon="pi pi-arrow-left" class="p-button-text p-button-lg" (click)="goBack()"></button>
      <div class="flex-1">
        <h2 class="text-2xl font-semibold" *ngIf="investment">{{ investment.name }}</h2>
        <p class="text-gray-500 text-sm mt-1" *ngIf="investment">{{ investment.description || 'Sem descrição' }}</p>
      </div>
    </div>

    <!-- Current Value Card -->
    <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-lg p-6 mb-6">
      <p class="text-gray-600 text-sm mb-2">Valor Atual</p>
      <p class="text-4xl font-bold text-green-600" *ngIf="investment">{{ investment.currentValue | currency:'BRL' }}</p>
    </div>

    <!-- Action Buttons -->
    <div class="grid grid-cols-3 gap-3 mb-6">
      <button pButton type="button" label="Depositar" icon="pi pi-arrow-down" class="p-button-success" (click)="openDeposit()"></button>
      <button pButton type="button" label="Sacar" icon="pi pi-arrow-up" class="p-button-warning" (click)="openWithdraw()"></button>
      <button pButton type="button" label="Ajustar" icon="pi pi-pencil" class="p-button-info" (click)="openAdjust()"></button>
    </div>

    <!-- Tabs Section -->
    <div class="border border-gray-200 rounded-lg p-6">
      <!-- Tab Buttons -->
      <div class="flex gap-2 mb-4">
        <button
          pButton
          type="button"
          [label]="'Histórico'"
          [icon]="'pi pi-list'"
          [class]="activeTab === 'history' ? 'p-button-primary' : 'p-button-outlined'"
          (click)="switchTab('history')"
        ></button>
        <button
          pButton
          type="button"
          [label]="'Gráficos'"
          [icon]="'pi pi-chart-line'"
          [class]="activeTab === 'charts' ? 'p-button-primary' : 'p-button-outlined'"
          (click)="switchTab('charts')"
        ></button>
      </div>

      <!-- History Tab Content -->
      <div *ngIf="activeTab === 'history'">
        <div *ngIf="!investment || !investment.histories || investment.histories.length === 0" class="text-center py-8">
          <i class="pi pi-inbox text-4xl text-gray-300 mb-3 block"></i>
          <p class="text-gray-500">Nenhuma movimentação registrada</p>
        </div>
        <div *ngIf="investment && investment.histories && investment.histories.length > 0" class="space-y-3">
          <div *ngFor="let history of investment.histories" class="flex items-center justify-between p-4 border border-gray-100 rounded-lg hover:bg-gray-50 transition">
            <div class="flex-1">
              <div class="flex items-center gap-3 mb-1">
                <span class="text-sm font-bold" [ngClass]="{
                  'text-green-600': isDepositOrAdjust(history),
                  'text-red-600': isWithdraw(history.type)
                }">
                  {{ getOperationType(history.type) }}
                </span>
                <span class="text-xs text-gray-400">{{ history.occurredAt | date:'dd/MM/yyyy' }}</span>
              </div>
              <p class="text-xs text-gray-500" *ngIf="history.note">{{ history.note }}</p>
            </div>
            <div class="text-right">
              <div class="text-sm font-semibold" [ngClass]="{
                'text-green-600': isDepositOrAdjust(history),
                'text-red-600': isWithdraw(history.type)
              }">
                {{ history.changeAmount | currency:'BRL' }}
              </div>
              <div class="text-xs text-gray-500">→ {{ history.totalValue | currency:'BRL' }}</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Tab Content -->
      <div *ngIf="activeTab === 'charts'">
        <div *ngIf="!investment || !investment.histories || investment.histories.length === 0" class="text-center py-8">
          <i class="pi pi-chart-bar text-4xl text-gray-300 mb-3 block"></i>
          <p class="text-gray-500">Sem dados para exibir gráficos</p>
        </div>
        <div *ngIf="investment && investment.histories && investment.histories.length > 0" class="space-y-6">
          <!-- Line Chart -->
          <div>
            <h4 class="text-md font-semibold mb-3">Evolução do Valor</h4>
            <div class="w-full">
              <p-chart type="line" [data]="lineChartData" [options]="chartOptions"></p-chart>
            </div>
          </div>

          <!-- Pie Chart -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
            <div>
              <h4 class="text-md font-semibold mb-3">Distribuição por Tipo</h4>
              <div class="w-full" style="height: 300px;">
                <p-chart type="pie" [data]="pieChartData" [options]="chartOptions"></p-chart>
              </div>
            </div>
            <div class="flex flex-col justify-center space-y-4">
              <div class="border border-gray-100 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full bg-green-500"></div>
                    <span class="text-sm font-medium">Total Depositado</span>
                  </div>
                  <span class="text-sm font-semibold text-green-600">
                    {{ (pieChartData?.datasets?.[0]?.data?.[0] || 0) | currency:'BRL' }}
                  </span>
                </div>
              </div>
              <div class="border border-gray-100 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full bg-yellow-500"></div>
                    <span class="text-sm font-medium">Total Sacado</span>
                  </div>
                  <span class="text-sm font-semibold text-yellow-600">
                    {{ (pieChartData?.datasets?.[0]?.data?.[1] || 0) | currency:'BRL' }}
                  </span>
                </div>
              </div>
              <div class="border border-gray-100 rounded-lg p-4">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2">
                    <div class="w-4 h-4 rounded-full bg-blue-500"></div>
                    <span class="text-sm font-medium">Total Ajustado</span>
                  </div>
                  <span class="text-sm font-semibold text-blue-600">
                    {{ (pieChartData?.datasets?.[0]?.data?.[2] || 0) | currency:'BRL' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Confirm Dialog -->
<p-confirmDialog></p-confirmDialog>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Deposit Dialog -->
<p-dialog header="Depositar" [(visible)]="depositVisible" [modal]="true" [style]="{ width: '28rem' }" appendTo="body">
  <form [formGroup]="depositForm" class="p-fluid p-3">
    <label>Valor <span class="text-red-500">*</span></label>
    <input
      pInputText
      formControlName="amount"
      appCurrencyMask
      thousandSeparator="."
      prefix="R$ "
      placeholder="R$ 0.00"
    />
    <div class="mt-3">
      <app-account-selector
        formControlName="accountId"
        label="Conta (opcional)"
        placeholder="Selecione uma conta"
        [required]="false"
      ></app-account-selector>
    </div>
    <label class="mt-3">Data <span class="text-red-500">*</span></label>
    <p-calendar formControlName="occurredAt"></p-calendar>
    <label class="mt-3">Observação</label>
    <input pInputText formControlName="note" placeholder="Digite uma observação" />
  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" class="p-button-text" (click)="depositVisible=false"></button>
    <button pButton label="Confirmar" class="p-button-success" (click)="confirmDeposit()" [disabled]="depositForm.invalid"></button>
  </ng-template>
</p-dialog>

<!-- Withdraw Dialog -->
<p-dialog header="Sacar" [(visible)]="withdrawVisible" [modal]="true" [style]="{ width: '28rem' }" appendTo="body">
  <form [formGroup]="withdrawForm" class="p-fluid p-3">
    <label>Valor <span class="text-red-500">*</span></label>
    <input
      pInputText
      formControlName="amount"
      appCurrencyMask
      thousandSeparator="."
      prefix="R$ "
      placeholder="R$ 0.00"
    />
    <div class="mt-3">
      <app-account-selector
        formControlName="accountId"
        label="Conta (opcional)"
        placeholder="Selecione uma conta"
        [required]="false"
      ></app-account-selector>
    </div>
    <label class="mt-3">Data <span class="text-red-500">*</span></label>
    <p-calendar formControlName="occurredAt"></p-calendar>
    <label class="mt-3">Observação</label>
    <input pInputText formControlName="note" placeholder="Digite uma observação" />
  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" class="p-button-text" (click)="withdrawVisible=false"></button>
    <button pButton label="Confirmar" class="p-button-warning" (click)="confirmWithdraw()" [disabled]="withdrawForm.invalid"></button>
  </ng-template>
</p-dialog>

<!-- Adjust Dialog -->
<p-dialog header="Ajustar Valor" [(visible)]="adjustVisible" [modal]="true" [style]="{ width: '28rem' }" appendTo="body">
  <form [formGroup]="adjustForm" class="p-fluid p-3">
    <label>Novo valor total <span class="text-red-500">*</span></label>
    <input
      pInputText
      formControlName="newTotalValue"
      appCurrencyMask
      thousandSeparator="."
      prefix="R$ "
      placeholder="R$ 0.00"
    />
    <label class="mt-3">Data <span class="text-red-500">*</span></label>
    <p-calendar formControlName="occurredAt"></p-calendar>
    <label class="mt-3">Observação</label>
    <input pInputText formControlName="note" placeholder="Digite uma observação" />
  </form>
  <ng-template pTemplate="footer">
    <button pButton label="Cancelar" class="p-button-text" (click)="adjustVisible=false"></button>
    <button pButton label="Confirmar" class="p-button-info" (click)="confirmAdjust()" [disabled]="adjustForm.invalid"></button>
  </ng-template>
</p-dialog>
